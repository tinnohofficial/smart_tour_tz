| FR ID | Functional Requirement Description                    | Related Use Case(s)                               | Backend Focus/Goal                                                                                                   | Key Backend Steps / API Logic Summary                                                                                                                                                                                                                                                           | Key Data Entities Involved | Relevant Pre/Post Conditions (Backend)                                                                                                                                                                                                                           | Potential Backend Exceptions / Edge Cases                                                                                                                                                                         |
| :---- | :---------------------------------------------------- | :------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| F2.2  | Apply to become a Hotel Manager (details, images, etc.) | Complete Hotel Manager Profile (4.4.4)            | API endpoint for Hotel Managers to submit/update their profile details.                                                | 1. `POST /api/users/me/profile/hotel-manager`: Authenticated user (role: hotel\_manager) sends request with hotel details (name, location, images, capacity, costs). <br> 2. Validate input data. <br> 3. `INSERT`/`UPDATE` `hotels` table linked to `users.id`. <br> 4. Update `users.status` to 'pending\_approval' if initial submission. | `users`, `hotels`          | **Pre:** User authenticated, role='hotel\_manager'. Request body valid. <br> **Post:** `hotels` record created/updated. `users.status` potentially updated.                                                                                                                  | Validation errors, Database error, User not hotel manager, User status not 'pending\_profile' for initial update.                                                                                               |
| F2.3  | Apply to become a Travel Agent (details, routes, etc.)  | Complete Travel Agent Profile (4.4.5)             | API endpoint for Travel Agents to submit/update their agency details and routes.                                       | 1. `POST /api/users/me/profile/travel-agent`: Authenticated user (role: travel\_agent) sends request with agency details (name, docs) and potentially initial routes. <br> 2. Validate input. <br> 3. `INSERT`/`UPDATE` `travel_agencies` table linked to `users.id`. <br> 4. (Potentially) `INSERT` into `transport_routes`. <br> 5. Update `users.status` to 'pending\_approval'. | `users`, `travel_agencies`, `transport_routes` | **Pre:** User authenticated, role='travel\_agent'. Request body valid. <br> **Post:** `travel_agencies` record created/updated. `users.status` potentially updated. Optional: `transport_routes` created.                                                                     | Validation errors, Database error, User not travel agent.                                                                                                                                                     |
| F4.1  | User update authentication credentials              | *Update Password UC (Implied)*                    | API endpoint to allow users to change their password.                                                                  | 1. `PUT /api/users/me/password`: Authenticated user sends request with `currentPassword` and `newPassword`. <br> 2. Fetch user's current `password_hash` from `users` table. <br> 3. Verify `currentPassword` against hash using `bcrypt.compare`. <br> 4. If match, hash `newPassword` using `bcrypt.hash`. <br> 5. `UPDATE` `users` table with new hash. | `users`                    | **Pre:** User authenticated. Request body valid (current/new passwords). <br> **Post:** `users.password_hash` updated.                                                                                                                                                   | Current password incorrect, New password fails validation (if any), Database error.                                                                                                                             |
| F4.2  | User update profile details according to role         | *Update Profile UCs (Implied)*                    | API endpoints for users (Guide/Manager/Agent) to update their *existing* profile details after approval.               | 1. `PUT /api/users/me/profile/{role}`: Authenticated user sends request with updated fields. <br> 2. Validate input. <br> 3. `UPDATE` corresponding profile table (`tour_guides`, `hotels`, `travel_agencies`) based on user ID and role.                                                              | `users`, `tour_guides`, `hotels`, `travel_agencies` | **Pre:** User authenticated, profile exists, status='active'. Request body valid. <br> **Post:** Profile table updated.                                                                                                                                                   | Validation errors, Database error, Profile not found, User role mismatch.                                                                                                                                   |
| F5.1  | Store credit card details for payment                 | Add Payment Information (4.4.7)                   | API endpoint to securely add/manage user payment methods (storing references, not raw data).                           | 1. `POST /api/users/me/payment-methods`: Authenticated Tourist sends request (likely with a token from a frontend payment gateway integration). <br> 2. Backend *may* interact with Payment Gateway API to confirm token/create customer profile. <br> 3. `INSERT` into `user_payment_methods` storing *only* non-sensitive data (last4, brand, expiry, gateway token/ref). | `users`, `user_payment_methods` | **Pre:** User authenticated, role='tourist'. Valid payment token/details provided. <br> **Post:** `user_payment_methods` record created with reference data.                                                                                                             | Invalid payment gateway token, Payment gateway error, Database error.                                                                                                                                          |
| F5.2  | Configure web3 wallet address for crypto payments     | Add Payment Information (4.4.7)                   | API endpoint to store a user's Web3 wallet address.                                                                    | 1. `PUT /api/users/me/wallet`: Authenticated Tourist sends request with `walletAddress`. <br> 2. Validate wallet address format. <br> 3. `UPDATE` `users` table (or a dedicated wallet table) with the address.                                                                               | `users`                    | **Pre:** User authenticated, role='tourist'. Valid wallet address format. <br> **Post:** User record updated with wallet address.                                                                                                                                    | Invalid address format, Database error.                                                                                                                                                                   |
| F5.3  | Deposit fiat funds for future trips                 | Save Fiat Funds (4.4.8)                           | API endpoint to process fiat deposits into a user's savings balance using a stored payment method.                     | 1. `POST /api/savings/deposit/fiat`: Authenticated Tourist sends request with `amount` and `paymentMethodId`. <br> 2. Fetch payment gateway token from `user_payment_methods`. <br> 3. Use Payment Gateway API to charge the specified amount. <br> 4. On success: `UPDATE` `savings_accounts` balance. <br> 5. `INSERT` into `savings_transactions` (type='deposit'). <br> 6. `INSERT` into `payments` (status='successful'). | `users`, `user_payment_methods`, `savings_accounts`, `savings_transactions`, `payments` | **Pre:** User authenticated, role='tourist', valid `paymentMethodId`, positive `amount`. <br> **Post:** Payment processed, `savings_accounts` balance increased, `savings_transactions` & `payments` records created. | Payment gateway failure, Insufficient funds on card, Invalid payment method ID, Database error.                                                                                                              |
| F5.5  | Deposit crypto funds for future trips               | Save Crypto Funds (4.4.9)                         | Backend interaction with Smart Contracts to handle crypto deposits/swaps and update balances.                            | 1. `POST /api/savings/deposit/crypto`: Authenticated Tourist sends request with `amount`, `tokenType`. <br> 2. Backend generates necessary data for Smart Contract interaction. <br> 3. Frontend uses data to initiate transaction via user's wallet (e.g., Metamask). <br> 4. Backend listens for Smart Contract events (e.g., `DepositSuccess`). <br> 5. On event: Update internal representation of crypto balance (if any), create `savings_transactions` (type='deposit', crypto). | `users`, `savings_transactions`, `Blockchain Smart Contracts` | **Pre:** User authenticated, role='tourist', has Web3 wallet configured. <br> **Post:** Smart contract interaction initiated/completed, backend balance/transaction log updated upon confirmation.                                                                         | Smart contract error, Blockchain network issues, Event listener failure, Insufficient gas.                                                                                                                    |
| F5.4/ F5.5 | Make instant/discounted payments for services       | Make Payment (4.4.15)                             | API endpoint to process payment for a booking using card, saved fiat, or saved crypto.                               | 1. `POST /api/bookings/{bookingId}/pay`: Authenticated Tourist sends request with `paymentMethod` ('card', 'savings\_fiat', 'savings\_crypto') and potentially `paymentMethodId`. <br> 2. Fetch `bookings` record, verify status ('pending\_payment') and `total_cost`. <br> 3. **If 'card':** Use Payment Gateway API via stored token. <br> 4. **If 'savings\_fiat':** Check `savings_accounts.balance_usd` >= `total_cost`. If yes, deduct balance, create `savings_transactions` (type='payment'). <br> 5. **If 'savings\_crypto':** Check internal crypto balance >= `total_cost`. If yes, deduct balance, potentially interact with contract for fund transfer. <br> 6. On success: `UPDATE` `bookings` status to 'confirmed'. <br> 7. `INSERT` into `payments` record. | `users`, `bookings`, `payments`, `savings_accounts`, `savings_transactions`, `user_payment_methods`, `Blockchain Smart Contracts` | **Pre:** User authenticated, role='tourist', valid `bookingId`, booking status='pending\_payment'. <br> *If savings:* Sufficient balance. <br> **Post:** Payment processed, `bookings.status`='confirmed', `payments` record created. Balance deducted if savings used. | Payment failure (gateway/contract), Insufficient savings balance, Invalid booking ID/status, Concurrency issues on balance updates.                                                                            |
| F6.1  | Browse list of tourist locations                    | Browse Locations (4.4.10)                         | API endpoint to retrieve a list of available destinations.                                                             | 1. `GET /api/destinations`: Request received. <br> 2. `SELECT` id, name, description, image\_url from `destinations` table. <br> 3. Return list of destinations.                                                                                                                               | `destinations`             | **Pre:** None. <br> **Post:** List of destinations returned.                                                                                                                                                                                                | Database error.                                                                                                                                                                                             |
| F6.2  | Get details for a specific location                 | Browse Locations (4.4.10) / Book Tour Package (4.4.11) | API endpoint to retrieve detailed information about one destination, including related entities.                       | 1. `GET /api/destinations/{destinationId}`: Request received. <br> 2. `SELECT` details from `destinations` where id = `{destinationId}`. <br> 3. Optionally JOIN/query `activities`, nearby `hotels` based on location. <br> 4. Return detailed destination object.                                           | `destinations`, `activities`, `hotels` | **Pre:** Valid `destinationId`. <br> **Post:** Detailed destination info returned.                                                                                                                                                                                   | Invalid/Not Found `destinationId`, Database error.                                                                                                                                                         |
| F6.3  | Get available transport options                     | Book Tour Package (4.4.11)                        | API endpoint to list transport routes based on origin/destination.                                                   | 1. `GET /api/transport-routes?destination={destId}&origin={origin}`: Request received. <br> 2. `SELECT` from `transport_routes` JOIN `travel_agencies` matching criteria. <br> 3. Return list of transport options with agency details.                                                            | `transport_routes`, `travel_agencies` | **Pre:** Valid query parameters. <br> **Post:** List of matching transport routes returned.                                                                                                                                                                      | Database error, No routes found.                                                                                                                                                                             |
| F6.4  | Get available tour guides                           | Book Tour Package (4.4.11)                        | API endpoint to list available tour guides based on location/expertise.                                                | 1. `GET /api/tour-guides?location={location}&expertise={term}`: Request received. <br> 2. `SELECT` from `tour_guides` JOIN `users` (where status='active') matching criteria. <br> 3. Return list of available guides.                                                                           | `tour_guides`, `users`     | **Pre:** Valid query parameters. <br> **Post:** List of matching tour guides returned.                                                                                                                                                                            | Database error, No guides found.                                                                                                                                                                              |
| F6.5  | Get available hotels                                | Book Tour Package (4.4.11)                        | API endpoint to list available hotels based on location/dates (basic).                                                 | 1. `GET /api/hotels?location={location}`: Request received. <br> 2. `SELECT` from `hotels` JOIN `users` (manager status='active') matching location. (Availability check is complex, maybe deferred). <br> 3. Return list of hotels.                                                                    | `hotels`, `users`          | **Pre:** Valid query parameters. <br> **Post:** List of matching hotels returned.                                                                                                                                                                                | Database error, No hotels found.                                                                                                                                                                              |
| F6.6  | Get available activities                            | Book Tour Package (4.4.11)                        | API endpoint to list activities for a destination.                                                                     | 1. `GET /api/activities?destinationId={destId}`: Request received. <br> 2. `SELECT` from `activities` where destination\_id = `{destId}`. <br> 3. Return list of activities.                                                                                                             | `activities`               | **Pre:** Valid `destinationId`. <br> **Post:** List of activities returned.                                                                                                                                                                                      | Database error, No activities found.                                                                                                                                                                           |
| F6.7  | Create a booking (save as pending payment)          | Book Tour Package (4.4.11)                        | API endpoint to create a new booking record with selected items, initially pending payment.                            | 1. `POST /api/bookings`: Authenticated Tourist sends request with selected items (transportId, hotelId, guideId, activityIds, dates, etc.). <br> 2. Validate item IDs exist and are available (basic check). <br> 3. Calculate `total_cost` by summing costs from selected items. <br> 4. `INSERT` into `bookings` (tourist\_user\_id, total\_cost, status='pending\_payment'). <br> 5. Get new `booking_id`. <br> 6. `INSERT` into `booking_items` for each selected item (linking to `booking_id`, item type, item ID, cost). | `users`, `bookings`, `booking_items`, `transport_routes`, `hotels`, `tour_guides`, `activities` | **Pre:** User authenticated, role='tourist'. Valid item IDs provided. <br> **Post:** `bookings` record created (status='pending\_payment'), `booking_items` records created. Returns new `booking_id`. | Invalid item IDs, Calculation error, Database constraint violation (FKs), Database error.                                                                                                                  |
| F6.8  | Travel Agent view pending bookings needing action     | Process Travel Bookings (4.4.12)                  | API endpoint for Travel Agents to fetch confirmed bookings where they need to assign tickets.                          | 1. `GET /api/agent/bookings?status=action_required`: Authenticated Travel Agent requests bookings. <br> 2. `SELECT` booking details JOIN `booking_items` where `item_type`='transport', `agency_id` matches agent's agency, `bookings.status`='confirmed', and `booking_items.provider_status`='pending'. <br> 3. Return list of relevant booking items. | `users`, `travel_agencies`, `bookings`, `booking_items` | **Pre:** User authenticated, role='travel\_agent'. <br> **Post:** List of booking items requiring ticket assignment returned.                                                                                                                             | Database error, User not linked to an agency.                                                                                                                                                               |
| F6.9  | Travel Agent assign ticket for confirmed booking    | Process Travel Bookings (4.4.12)                  | API endpoint for Travel Agents to update a booking item with ticket details.                                         | 1. `PATCH /api/agent/bookings/items/{itemId}/assign-ticket`: Authenticated Travel Agent sends request with ticket details. <br> 2. Validate agent owns/manages this `booking_items` record (`itemId`). <br> 3. `UPDATE` `booking_items` SET `item_details` = JSON(ticket info), `provider_status` = 'confirmed' WHERE id = `{itemId}`. | `users`, `travel_agencies`, `booking_items` | **Pre:** User authenticated, role='travel\_agent'. Valid `itemId`. Item belongs to agent's agency. Item status='pending'. <br> **Post:** `booking_items` record updated with ticket details and status 'confirmed'.                                                      | Item not found, Permission denied (not agent's item), Invalid state (already confirmed/rejected), Database error.                                                                                               |
| F6.10 | Hotel Manager view pending reservations needing action | Process Hotel Bookings (4.4.13)                   | API endpoint for Hotel Managers to fetch confirmed bookings requiring room confirmation.                               | 1. `GET /api/hotel/bookings?status=action_required`: Authenticated Hotel Manager requests bookings. <br> 2. `SELECT` booking details JOIN `booking_items` where `item_type`='hotel', `item_id` matches manager's hotel, `bookings.status`='confirmed', `booking_items.provider_status`='pending'. <br> 3. Return list of relevant booking items. | `users`, `hotels`, `bookings`, `booking_items` | **Pre:** User authenticated, role='hotel\_manager'. <br> **Post:** List of booking items requiring room confirmation returned.                                                                                                                               | Database error, User not linked to a hotel.                                                                                                                                                                  |
| F6.11 | Hotel Manager secure reservation (specify room)     | Process Hotel Bookings (4.4.13)                   | API endpoint for Hotel Managers to confirm a room reservation for a booking item.                                    | 1. `PATCH /api/hotel/bookings/items/{itemId}/confirm-room`: Authenticated Hotel Manager sends request with room details. <br> 2. Validate manager owns/manages this `booking_items` record (`itemId`). <br> 3. `UPDATE` `booking_items` SET `item_details` = JSON(room info), `provider_status` = 'confirmed' WHERE id = `{itemId}`. | `users`, `hotels`, `booking_items` | **Pre:** User authenticated, role='hotel\_manager'. Valid `itemId`. Item belongs to manager's hotel. Item status='pending'. <br> **Post:** `booking_items` record updated with room details and status 'confirmed'.                                                    | Item not found, Permission denied, Invalid state, Database error.                                                                                                                                             |
| *N/A* | View Tour Guide Bookings                            | View tour guide bookings (4.4.14)                 | API endpoint for Tour Guides to view their confirmed assignments.                                                    | 1. `GET /api/guide/bookings`: Authenticated Tour Guide requests their schedule. <br> 2. `SELECT` booking details JOIN `booking_items` where `item_type`='tour_guide', `item_id` = guide's `user_id`, `bookings.status`='confirmed'. <br> 3. Return list of assigned guiding jobs (dates, tourist info, etc.). | `users`, `tour_guides`, `bookings`, `booking_items` | **Pre:** User authenticated, role='tour\_guide'. <br> **Post:** List of confirmed guide bookings returned.                                                                                                                                                        | Database error.                                                                                                                                                                                             |